from swebench.harness import prepare_images
import datasets
import argparse

to_build = [
    "astropy__astropy-12907",
"astropy__astropy-13068",
"astropy__astropy-13236",
"astropy__astropy-13306",
"astropy__astropy-13390",
"astropy__astropy-13398",
"astropy__astropy-13462",
"astropy__astropy-13579",
"astropy__astropy-13638",
"astropy__astropy-13734",
"astropy__astropy-13745",
"astropy__astropy-13838",
"astropy__astropy-13933",
"astropy__astropy-13977",
"astropy__astropy-14096",
"astropy__astropy-14182",
"django__django-10087",
"django__django-10097",
"django__django-10213",
"django__django-10301",
"django__django-10316",
"django__django-10426",
"django__django-10737",
"django__django-10853",
"django__django-10880",
"django__django-10910",
"django__django-10939",
"django__django-10973",
"django__django-11003",
"django__django-11019",
"django__django-11034",
"django__django-11062",
"django__django-11070",
"django__django-11085",
"django__django-11087",
"django__django-11095",
"django__django-11099",
"django__django-11115",
"django__django-11129",
"django__django-11133",
"django__django-11141",
"django__django-11149",
"django__django-11155",
"django__django-11169",
"django__django-11205",
"django__django-11206",
"django__django-11211",
"django__django-11214",
"django__django-11216",
"django__django-11399",
"django__django-11400",
"django__django-11405",
"django__django-11422",
"django__django-11423",
"django__django-11428",
"django__django-11433",
"django__django-11446",
"django__django-11457",
"django__django-11490",
"django__django-11501",
"django__django-11514",
"django__django-11517",
"django__django-11527",
"django__django-11539",
"django__django-11543",
"django__django-11550",
"django__django-11551",
"django__django-11559",
"django__django-11560",
"django__django-11564",
"django__django-11583",
"django__django-11584",
"django__django-11591",
"django__django-11592",
"django__django-11603",
"django__django-11605",
"django__django-11612",
"django__django-11618",
"django__django-11620",
"django__django-11622",
"django__django-11630",
"django__django-11848",
"django__django-11880",
"django__django-11883",
"django__django-11891",
"django__django-11893",
"django__django-11894",
"django__django-11903",
"django__django-11905",
"django__django-11911",
"django__django-11916",
"django__django-11951",
"django__django-11983",
"django__django-11991",
"django__django-11997",
"django__django-11999",
"django__django-12009",
"django__django-12039",
"django__django-12049",
"django__django-12050",
"django__django-12073",
"django__django-12091",
"django__django-12113",
"django__django-12121",
"django__django-12122",
"django__django-12125",
"django__django-12132",
"django__django-12143",
"django__django-12148",
"django__django-12153",
"django__django-12155",
"django__django-12161",
"django__django-12172",
"django__django-12184",
"django__django-12406",
"django__django-12419",
"django__django-12430",
"django__django-12431",
"django__django-12453",
"django__django-12458",
"django__django-12464",
"django__django-12469",
"django__django-12484",
"django__django-12485",
"django__django-12486",
"django__django-12496",
"django__django-12503",
"django__django-12504",
"django__django-12508",
"django__django-12513",
"django__django-12517",
"django__django-12518",
"django__django-12519",
"django__django-12532",
"django__django-12553",
"django__django-12556",
"django__django-12568",
"django__django-12588",
"django__django-12589",
"django__django-12591",
"django__django-12613",
"django__django-12627",
"django__django-12630",
"django__django-12663",
"django__django-12669",
"django__django-12671",
"django__django-12953",
"django__django-12961",
"django__django-12965",
"django__django-12973",
"django__django-12983",
"django__django-13022",
"django__django-13023",
"django__django-13030",
"django__django-13032",
"django__django-13033",
"django__django-13066",
"django__django-13077",
"django__django-13097",
"django__django-13109",
"django__django-13111",
"django__django-13112",
"django__django-13115",
"django__django-13118",
"django__django-13121",
"django__django-13128",
"django__django-13145",
"django__django-13158",
"django__django-13162",
"django__django-13165",
"django__django-13170",
"django__django-13192",
"django__django-13195",
"django__django-13199",
"django__django-13207",
"django__django-13212",
"django__django-13300",
"django__django-13301",
"django__django-13369",
"django__django-13371",
"django__django-13386",
"django__django-13410",
"django__django-13413",
"django__django-13417",
"django__django-13426",
"django__django-13431",
"django__django-13447",
"django__django-13448",
"django__django-13449",
"django__django-13454",
"django__django-13458",
"django__django-13460",
"django__django-13466",
"django__django-13484",
"django__django-13490",
"django__django-13495",
"django__django-13512",
"django__django-13513",
"django__django-13516",
"django__django-13528",
"django__django-13530",
"django__django-13551",
"django__django-13553",
"django__django-13556",
"django__django-13560",
"django__django-13568",
"django__django-13569",
"django__django-13578",
"django__django-13585",
"django__django-13786",
"django__django-13791",
"django__django-13794",
"django__django-13797",
"django__django-13800",
"django__django-13807",
"django__django-13808",
"django__django-13809",
"django__django-13810",
"django__django-13820",
"django__django-13821",
"django__django-13822",
"django__django-13824",
"django__django-13837",
"django__django-13841",
"django__django-13884",
"django__django-13915",
"django__django-13924",
"django__django-13925",
"django__django-13933",
"django__django-13952",
"django__django-13964",
"django__django-13992",
"django__django-13995",
"django__django-14007",
"django__django-14011",
"django__django-14014",
"django__django-14016",
"django__django-14017",
"django__django-14019",
"django__django-14026",
"django__django-14089",
"django__django-14282",
"django__django-14291",
"django__django-14309",
"django__django-14311",
"django__django-14313",
"django__django-14315",
"django__django-14324",
"django__django-14336",
"django__django-14341",
"django__django-14349",
"django__django-14351",
"django__django-14372",
"django__django-14382",
"django__django-14385",
"django__django-14395",
"django__django-14396",
"django__django-14404",
"django__django-14407",
"django__django-14411",
"django__django-14416",
"django__django-14430",
"django__django-14434",
"django__django-14441",
"django__django-14444",
"django__django-14447",
"django__django-14451",
"django__django-14453",
"django__django-14463",
"django__django-14471",
"django__django-14534",
"django__django-14599",
"django__django-14681",
"django__django-14717",
"django__django-14722",
"django__django-14730",
"django__django-14751",
"django__django-14752",
"django__django-14762",
"django__django-14771",
"django__django-14779",
"django__django-14785",
"django__django-14787",
"django__django-14792",
"django__django-14802",
"django__django-14805",
"django__django-14812",
"django__django-14832",
"django__django-14855",
"django__django-14861",
"django__django-14871",
"django__django-14878",
"django__django-14880",
"django__django-14890",
"django__django-14894",
"django__django-14916",
"django__django-14919",
"django__django-14935",
"django__django-14954",
"django__django-14960",
"django__django-14969",
"django__django-14983",
"django__django-14996",
"django__django-14997",
"django__django-14999",
"django__django-15018",
"django__django-15022",
"django__django-15031",
"django__django-15213",
"django__django-15240",
"django__django-15252",
"django__django-15272",
"django__django-15277",
"django__django-15280",
"django__django-15292",
"django__django-15297",
"django__django-15316",
"django__django-15318",
"django__django-15320",
"django__django-15334",
"django__django-15342",
"django__django-15352",
"django__django-15368",
"django__django-15370",
"django__django-15380",
"django__django-15382",
"django__django-15388",
"django__django-15401",
"django__django-15414",
"django__django-15421",
"django__django-15433",
"django__django-15438",
"django__django-15442",
"django__django-15467",
"django__django-15474",
"django__django-15481",
"django__django-15497",
"django__django-15503",
"django__django-15521",
"django__django-15525",
"django__django-15651",
"django__django-15703",
"django__django-15731",
"django__django-15732",
"django__django-15737",
"django__django-15738",
"django__django-15741",
"django__django-15742",
"django__django-15744",
"django__django-15747",
"django__django-15752",
"django__django-15766",
"django__django-15774",
"django__django-15781",
"django__django-15789",
"django__django-15790",
"django__django-15799",
"django__django-15814",
"django__django-15819",
"django__django-15828",
"django__django-15863",
"django__django-15902",
"django__django-15916",
"django__django-15925",
"django__django-15930",
"django__django-15957",
"django__django-15969",
"django__django-15973",
"django__django-15987",
"django__django-15993",
"django__django-16037",
"django__django-16041",
"django__django-16046",
"django__django-16263",
"django__django-16302",
"django__django-16306",
"django__django-16311",
"django__django-16317",
"django__django-16322",
"django__django-16333",
"django__django-16343",
"django__django-16366",
"django__django-16369",
"django__django-16379",
"django__django-16398",
"django__django-16400",
"django__django-16408",
"django__django-16411",
"django__django-16429",
"django__django-16454",
"django__django-16485",
"django__django-16491",
"django__django-16493",
"django__django-16501",
"django__django-16502",
"django__django-16511",
"django__django-16514",
"django__django-16517",
"django__django-16527",
"django__django-16532",
"django__django-16560",
"django__django-16569",
"django__django-16578",
"django__django-16588",
"django__django-16612",
"django__django-16614",
"django__django-16629",
"django__django-16686",
"django__django-16802",
"django__django-16810",
"django__django-16816",
"django__django-16819",
"django__django-16820",
"django__django-16824",
"django__django-16865",
"django__django-16873",
"django__django-16879",
"django__django-16883",
"django__django-16888",
"django__django-16899",
"django__django-16902",
"django__django-16903",
"django__django-16910",
"django__django-16948",
"django__django-16950",
"django__django-16952",
"django__django-16983",
"django__django-17029",
"django__django-17045",
"django__django-17046",
"django__django-17051",
"django__django-17058",
"django__django-17065",
"django__django-17066",
"django__django-17084",
"django__django-17087",
"django__django-5158",
"django__django-8326",
"django__django-8630",
"matplotlib__matplotlib-19743",
"matplotlib__matplotlib-19763",
"matplotlib__matplotlib-20470",
"matplotlib__matplotlib-20488",
"matplotlib__matplotlib-20679",
"matplotlib__matplotlib-20788",
"matplotlib__matplotlib-20805",
"matplotlib__matplotlib-20816",
"matplotlib__matplotlib-21042",
"matplotlib__matplotlib-21238",
"matplotlib__matplotlib-21318",
"matplotlib__matplotlib-21443",
"matplotlib__matplotlib-21481",
"matplotlib__matplotlib-21490",
"matplotlib__matplotlib-21542",
"matplotlib__matplotlib-21550",
"matplotlib__matplotlib-21559",
"matplotlib__matplotlib-21568",
"matplotlib__matplotlib-21570",
"matplotlib__matplotlib-21617",
"matplotlib__matplotlib-22711",
"matplotlib__matplotlib-22719",
"matplotlib__matplotlib-22734",
"matplotlib__matplotlib-22767",
"matplotlib__matplotlib-22815",
"matplotlib__matplotlib-22835",
"matplotlib__matplotlib-22865",
"matplotlib__matplotlib-22871",
"matplotlib__matplotlib-22883",
"matplotlib__matplotlib-22926",
"matplotlib__matplotlib-22929",
"matplotlib__matplotlib-22931",
"matplotlib__matplotlib-22945",
"matplotlib__matplotlib-22991",
"matplotlib__matplotlib-23031",
"matplotlib__matplotlib-23047",
"matplotlib__matplotlib-23049",
"matplotlib__matplotlib-23057",
"matplotlib__matplotlib-23088",
"matplotlib__matplotlib-23111",
"matplotlib__matplotlib-23140",
"matplotlib__matplotlib-23174",
"matplotlib__matplotlib-23188",
"matplotlib__matplotlib-23198",
"matplotlib__matplotlib-23203",
"matplotlib__matplotlib-23266",
"matplotlib__matplotlib-23267",
"matplotlib__matplotlib-23562",
"matplotlib__matplotlib-23913",
"matplotlib__matplotlib-23987",
"matplotlib__matplotlib-24026",
"matplotlib__matplotlib-24111",
"matplotlib__matplotlib-24149",
"matplotlib__matplotlib-24177",
"matplotlib__matplotlib-24189",
"matplotlib__matplotlib-24224",
"matplotlib__matplotlib-24257",
"matplotlib__matplotlib-24265",
"matplotlib__matplotlib-24334",
"matplotlib__matplotlib-24362",
"matplotlib__matplotlib-24403",
"matplotlib__matplotlib-24538",
"matplotlib__matplotlib-24570",
"matplotlib__matplotlib-24604",
"matplotlib__matplotlib-24619",
"matplotlib__matplotlib-24627",
"matplotlib__matplotlib-24637",
"matplotlib__matplotlib-24691",
"matplotlib__matplotlib-24749",
"matplotlib__matplotlib-24768",
"matplotlib__matplotlib-24849",
"matplotlib__matplotlib-24870",
"matplotlib__matplotlib-24912",
"matplotlib__matplotlib-24924",
"matplotlib__matplotlib-24970",
"matplotlib__matplotlib-24971",
"matplotlib__matplotlib-25027",
"matplotlib__matplotlib-25052",
"matplotlib__matplotlib-25079",
"matplotlib__matplotlib-25085",
"matplotlib__matplotlib-25122",
"matplotlib__matplotlib-25126",
"matplotlib__matplotlib-25129",
"matplotlib__matplotlib-25238",
"matplotlib__matplotlib-25281",
"matplotlib__matplotlib-25287",
"matplotlib__matplotlib-25311",
"matplotlib__matplotlib-25332",
"matplotlib__matplotlib-25334",
"matplotlib__matplotlib-25340",
"matplotlib__matplotlib-25346",
"matplotlib__matplotlib-25404",
"matplotlib__matplotlib-25405",
"matplotlib__matplotlib-25425",
"matplotlib__matplotlib-25479",
"matplotlib__matplotlib-25498",
"matplotlib__matplotlib-25551",
"matplotlib__matplotlib-25746",
"matplotlib__matplotlib-25775",
"matplotlib__matplotlib-25785",
"matplotlib__matplotlib-25794",
"matplotlib__matplotlib-25859",
"matplotlib__matplotlib-25960",
"matplotlib__matplotlib-26011",
"matplotlib__matplotlib-26020",
"matplotlib__matplotlib-26024",
"matplotlib__matplotlib-26078",
"matplotlib__matplotlib-26089",
"matplotlib__matplotlib-26101",
"matplotlib__matplotlib-26113",
"matplotlib__matplotlib-26122",
"matplotlib__matplotlib-26160",
"matplotlib__matplotlib-26184",
"matplotlib__matplotlib-26208",
"matplotlib__matplotlib-26223",
"matplotlib__matplotlib-26232",
"matplotlib__matplotlib-26249",
"matplotlib__matplotlib-26278",
"matplotlib__matplotlib-26285",
"matplotlib__matplotlib-26291",
"matplotlib__matplotlib-26300",
"matplotlib__matplotlib-26311",
"matplotlib__matplotlib-26341",
"matplotlib__matplotlib-26342",
"matplotlib__matplotlib-26399",
"matplotlib__matplotlib-26466",
"matplotlib__matplotlib-26469",
"matplotlib__matplotlib-26472",
"matplotlib__matplotlib-26479",
"matplotlib__matplotlib-26532",
"sympy__sympy-11384",
"sympy__sympy-11919",
"sympy__sympy-12307",
"sympy__sympy-12812",
"sympy__sympy-12881",
"sympy__sympy-13146",
"sympy__sympy-13259",
"sympy__sympy-13372",
"sympy__sympy-13798",
"sympy__sympy-13865",
"sympy__sympy-13877",
"sympy__sympy-14317",
"sympy__sympy-14333",
"sympy__sympy-14627",
"sympy__sympy-14699",
"sympy__sympy-14817",
"sympy__sympy-14821",
"sympy__sympy-14976",
"sympy__sympy-15151",
"sympy__sympy-15198",
"sympy__sympy-15635",
"sympy__sympy-15678",
"sympy__sympy-15685",
"sympy__sympy-15809",
"sympy__sympy-15933",
"sympy__sympy-16474",
"sympy__sympy-16503",
"sympy__sympy-16597",
"sympy__sympy-16601",
"sympy__sympy-16632",
"sympy__sympy-16637",
"sympy__sympy-16886",
"sympy__sympy-17394",
"sympy__sympy-17512",
"sympy__sympy-17630",
"sympy__sympy-17770",
"sympy__sympy-18130",
"sympy__sympy-18191",
"sympy__sympy-18199",
"sympy__sympy-18200",
"sympy__sympy-18211",
"sympy__sympy-18532",
"sympy__sympy-18587",
"sympy__sympy-19495",
"sympy__sympy-19601",
"sympy__sympy-19885",
"sympy__sympy-20428",
"sympy__sympy-20438",
"sympy__sympy-20442",
"sympy__sympy-20476",
"sympy__sympy-20801",
"sympy__sympy-20916",
"sympy__sympy-21259",
"sympy__sympy-21260",
"sympy__sympy-21271",
"sympy__sympy-21286",
"sympy__sympy-21476",
"sympy__sympy-23534",
"sympy__sympy-23729",
"sympy__sympy-24152",
"sympy__sympy-24370",
"sympy__sympy-24443",
"sympy__sympy-24455",
"sympy__sympy-24539",
"sympy__sympy-24562",
"sympy__sympy-24638",
]

def build(dataset_name, repo, limit=None):
    dataset = datasets.load_dataset(dataset_name)
    split = 'test'
    dataset = dataset[split]

    if repo:
        dataset = dataset.filter(lambda x: x['repo'] == repo)

    instance_ids = dataset['instance_id']
    
    instance_ids = [x for x in instance_ids if x in to_build]

    if limit:
        instance_ids = instance_ids[:limit]

    print(f"Building images for {len(instance_ids)} instances for repo: {repo or 'all repos'}")

    prepare_images.main(
        dataset_name=dataset_name,
        split=split,
        instance_ids=instance_ids,
        max_workers=64,
        force_rebuild=False,
        open_file_limit=8192,
    )


if __name__ == '__main__':
    parser = argparse.ArgumentParser(description='Build SWE-bench images')
    parser.add_argument('--repo', type=str, help='Repository to build images for (e.g., astropy/astropy)')
    parser.add_argument('--dataset', type=str, default='princeton-nlp/SWE-bench', help='Dataset name')
    parser.add_argument('--limit', type=int, help='Limit number of instances to build')
    
    args = parser.parse_args()
    
    build(args.dataset, args.repo, args.limit)